<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Verbal Transformation Effect Experiment</title>
  <style>
    :root {
      --bg: #82c5e4;
      --text: #111;
      --accent: #01366f;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Trebuchet MS', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      overflow: auto;
    }
    #progressBarContainer {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 200px;
        height: 20px;
        background: #ddd;
        border-radius: 10px;
        overflow: hidden;
        display: block;
    }
    #progressBar {
        height: 100%;
        width: 0%;
        background: var(--accent);
    }
    section {
      text-align: center;
      max-width: 800px;
      padding: 40px;
      display: none;
    }
    section.active {
      display: block;
    }
    #introScreen {flex-direction: column; align-items: center;}
    #introScreen.active {display: flex;}
    #introScreen h1 {font-weight: bold; margin-top: 60px;}
    #introScreen p {max-width: 600px; line-height: 1.6;}
    video, audio {
      width: 800px;
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    button {
      padding: 6px 12px;
      font-size: 1rem;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {background-color: #c9dff8; color: black;}
  </style>
</head>

<script>
  window.volumeCheck = function () {
    document.getElementById('introScreen').classList.remove('active');
    document.getElementById('volumeCheckScreen').classList.add('active');
    const a = document.getElementById('volumeCheckAudio');
    if (a) a.play().catch(()=>{}); // start the volume check audio
  };

  window.exampleVideo = function () {
    document.getElementById('volumeCheckScreen').classList.remove('active');
    document.getElementById('exampleVideoScreen').classList.add('active');
  };
</script>

<script>
function startExperiment() {
  document.getElementById('introScreen').classList.remove('active');
  document.getElementById('volumeCheckScreen').classList.remove('active');
  document.getElementById('exampleVideoScreen').classList.remove('active');
  trialScreen.classList.add('active');
  currentIndex = 0;
  loadVideo();
}
</script>

<body>
  <div id="progressBarContainer"><div id="progressBar"></div></div>

<section id="introScreen" class="active">
  <h1>Welcome to the Experiment</h1>
  <p>This experiment will measure how you perceive repeated ambiguous speech.</p>
  <p>When watching each video:</p>
  <p>Press <strong>D</strong> if you hear “farewell” and <strong>K</strong> if you hear “welfare.”  
     Each time your perception switches, press the appropriate key again.</p>
  <button onclick="volumeCheck()">Click to proceed to the next page</button>
</section>

<section id="volumeCheckScreen">
  <h2>Volume Check</h2>
  <p>Please ensure your volume is at a comfortable level.</p>
  <audio id="volumeCheckAudio" controls>
    <source src="volume_check.mp3" type="video/mp4">
    Your browser does not support the audio element.
  </audio>
  <div style="margin-top:20px;">
    <button onclick="exampleVideo()">Click to proceed to the next page</button>
  </div>
</section>

  <section id="exampleVideoScreen">
    <h2>Example Video</h2>
    <p>Here is an example video to familiarize you with the task.</p>
    <video id="exampleVideo" autoplay playsinline controls>
      <source src="example_video.mp4" type="video/mp4">
      Your browser does not support the video element.
    </video>
    <div style="margin-top:20px;">
      <button onclick="startExperiment()">Continue to Experiment</button>
    </div>
  </section>

<section id="trialScreen">
  <h2 id="trialInstruction"></h2>
  <video id="stimulusVideo" autoplay playsinline controls></video>
  <source src="video1.mp4" type="video/mp4">
  <p>Press <strong>D</strong> if you hear “farewell” and <strong>K</strong> if you hear “welfare.”  
  <div style="margin-top:20px;">
    <button id="nextBtn">Next Video</button>
  </div>
</section>

<section id="thankYouMessage">
  <h2>Thank you for participating!</h2>
  <p>You may now close this tab.</p>
</section>

<script>
  const videos = [
    {file: 'video1.mp4', condition: 'A only'},
    {file: 'video2.mp4', condition: 'Farewell AV: no gesture'},
    {file: 'video3.mp4', condition: 'Fare AV: hand gesture'},
    {file: 'video4.mp4', condition: 'Well AV: hand gesture'},
    {file: 'video5.mp4', condition: 'Fare AV: head gesture'},
    {file: 'video6.mp4', condition: 'Well AV: head gesture'},
    {file: 'example_video.mp4', condition: 'Example video'}
  ];

  let currentIndex = 0;
  const mediaEl = document.getElementById('stimulusVideo');
  const progressBar = document.getElementById('progressBar');
  const trialScreen = document.getElementById('trialScreen');
  const thankYouMessage = document.getElementById('thankYouMessage');
  let responseData = [];
  let lastKeyPressTime = null;

  function updateProgressBar() {
    progressBar.style.width = (currentIndex / videos.length) * 100 + "%";
  }

  function loadVideo() {
    updateProgressBar();
    const trialNumber = currentIndex + 1;
    document.getElementById('trialInstruction').textContent =
      `Video ${trialNumber} of ${videos.length} — Press D if “farewell”, K if “welfare”`;
    mediaEl.src = videos[currentIndex].file;
    mediaEl.currentTime = 0;
    mediaEl.play();
  }

  loadVideo();

  document.getElementById('nextBtn').onclick = () => {
    mediaEl.pause();
    currentIndex++;
    if (currentIndex < videos.length) {
      loadVideo();
    } else {
      trialScreen.classList.remove('active');
      document.getElementById('progressBarContainer').style.display = 'none';
      thankYouMessage.classList.add('active');
      thankYouMessage.scrollIntoView({ behavior: "smooth" });
      console.log('All responses:', responseData);
    }
  };

//Toggle test mode here
const TEST_MODE = true;  
const API_URL = "https://sheetdb.io/api/v1/tar154b79cjl1";

document.addEventListener('keydown', (e) => {
  if (!trialScreen.classList.contains('active')) return;
  if (e.key.toLowerCase() === 'd' || e.key.toLowerCase() === 'k') {
    const now = new Date();

    // Convert to EST
    const estTime = new Date(now.toLocaleString("en-US", { timeZone: "America/New_York" }));

    const formattedTime = `${estTime.getFullYear()}-${String(estTime.getMonth()+1).padStart(2,'0')}-${String(estTime.getDate()).padStart(2,'0')} ` +
                          `${String(estTime.getHours()).padStart(2,'0')}:${String(estTime.getMinutes()).padStart(2,'0')}:${String(estTime.getSeconds()).padStart(2,'0')}.${estTime.getMilliseconds()}`;

    const rt = lastKeyPressTime ? (now - lastKeyPressTime) / 1000 : null;
    lastKeyPressTime = now;

    const entry = {
      participantId: localStorage.getItem('participantId') || 'P' + Math.floor(Math.random() * 1e6),
      trialNumber: currentIndex + 1,
      videoFile: videos[currentIndex].file,
      condition: videos[currentIndex].condition,
      keyPressed: e.key.toLowerCase(),
      timeInStimulus: mediaEl.currentTime.toFixed(2),
      reactionTimeSinceLastPress: rt,
      timestampEST: formattedTime
    };

    responseData.push(entry);
    console.log('Recorded response:', entry);

    //Send to SheetDB only if not in test mode
    if (!TEST_MODE) {
      fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: entry })
      })
      .then(res => res.json())
      .then(data => console.log("Sent to SheetDB:", data))
      .catch(err => console.error("Error sending to SheetDB:", err));
    } else {
      console.log("IN TEST MODE — not sent to SheetDB. Data would be:", entry);
    }
  }
});

  if (!localStorage.getItem('participantId')) {
    localStorage.setItem('participantId', 'P' + Math.floor(Math.random() * 1000000));
  }
</script>
</body>
</html>
