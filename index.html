<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Verbal Transformation Effect Experiment</title>
  <style>
    :root {
      --bg: #82c5e4;
      --text: #111;
      --accent: #01366f;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Trebuchet MS', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      overflow: auto;
    }
    section {
      text-align: center;
      max-width: 800px;
      padding: 40px;
      display: none;
    }
    section.active {
      display: block;
    }
    #introScreen {flex-direction: column; align-items: center;}
    #introScreen.active {display: flex;}
    #introScreen h1 {font-weight: bold; margin-top: 60px;}
    #introScreen p {max-width: 600px; line-height: 1.6;}
    video, audio {
      width: 800px;
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    button {
      padding: 6px 12px;
      font-size: 1rem;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {background-color: #c9dff8; color: black;}

    .loopProgressContainer {
      width: 80%;
      height: 10px;
      background: #ddd;
      margin: 10px auto;
      border-radius: 5px;
      overflow: hidden;
    }
    .loopProgressBar {
      height: 100%;
      width: 0%;
      background: var(--accent);
      transition: width 0.2s linear;
    }

    .key-indicator {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 10px;
    }
    .key-box {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background-color: #eee;
      color: #333;
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background-color 0.2s, transform 0.1s;
    }
    .key-box.active {
      background-color: #4caf50;
      color: white;
      transform: scale(1.1);
    }
  </style>
</head>

<body>
<!-- INTRO PAGE -->
<section id="introScreen" class="active">
  <h1>Welcome to the Experiment</h1>
  <p>This experiment will measure how you perceive repeated ambiguous speech.</p>
  <p>Press <strong>D</strong> if you hear “farewell” and <strong>K</strong> if you hear “welfare.”  
  Each time your perception switches, press the appropriate key again.</p>
  <button onclick="showSection('idEntryScreen')">Click to proceed to the next page</button>
</section>

<!-- ID ENTRY PAGE -->
<section id="idEntryScreen">
  <h2>Participant ID</h2>
  <p>Please enter your Penn Participant ID exactly as it appears in SONA.</p>
  <input 
    id="participantIdInput"
    type="text"
    placeholder="Enter Participant ID"
    style="padding:10px; font-size:1.1rem; width:250px; border-radius:6px; border:1px solid #ccc; text-align:center;"
  />
  <br><br>
  <button onclick="storeIDandContinue()">Continue</button>
  <p id="idError" style="color:red; display:none; margin-top:10px;">
    Please enter your ID before continuing.
  </p>
</section>

<!-- VOLUME CHECK -->
<section id="volumeCheckScreen">
  <h2>Volume Check</h2>
  <p>Please ensure your volume is at a comfortable level.</p>
  <video id="volumeCheckAudio" autoplay playsinline controls>
      <source src="https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception-1/main/volumecheck.mp4" type="video/mp4">
  </video>
  <button onclick="showSection('exampleVideoScreen')">Click to proceed to the next page</button>
</section>

<!-- EXAMPLE VIDEO -->
<section id="exampleVideoScreen">
  <h2>Example Video</h2>
  <video autoplay playsinline controls>
    <source src="https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception/main/example_video.mp4" type="video/mp4">
  </video>
  <button onclick="showSection('trial1')">Continue to Experiment</button>
</section>

<!-- TRIAL 1 — Audio: Farewell only -->
<section id="trial1">
  <h2>Trial 1</h2>
  <div class="key-indicator">
    <div id="keyD1" class="key-box">D</div>
    <div id="keyK1" class="key-box">K</div>
  </div>
  <video id="vid1" autoplay playsinline preload="auto">
    <source src="https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception/main/video1.mp4" type="video/mp4">
  </video>
  <div class="loopProgressContainer">
    <div class="loopProgressBar" id="progress1"></div>
  </div>
  <p>Press <strong>D</strong> for “farewell” and <strong>K</strong> for “welfare.”</p>
  <button onclick="nextTrial()">Continue to Experiment</button>
</section>

<!-- TRIAL 2 — Farewell AV -->
<section id="trial2">
  <h2>Trial 2</h2>
  <div class="key-indicator">
    <div id="keyD2" class="key-box">D</div>
    <div id="keyK2" class="key-box">K</div>
  </div>
  <video id="vid2" autoplay playsinline preload="auto">
    <source src="https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception/main/video2.mp4" type="video/mp4">
  </video>
  <div class="loopProgressContainer">
    <div class="loopProgressBar" id="progress2"></div>
  </div>
  <p>Press <strong>D</strong> for “farewell” and <strong>K</strong> for “welfare.”</p>
  <button onclick="nextTrial()">Continue to Experiment</button>
</section>

<!-- TRIAL 3 — Farewell + Hand Gesture -->
<section id="trial3">
  <h2>Trial 3</h2>
  <div class="key-indicator">
    <div id="keyD3" class="key-box">D</div>
    <div id="keyK3" class="key-box">K</div>
  </div>
  <video id="vid3" autoplay playsinline preload="auto">
    <source src="https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception/main/video3.mp4" type="video/mp4">
  </video>
  <div class="loopProgressContainer">
    <div class="loopProgressBar" id="progress3"></div>
  </div>
  <p>Press <strong>D</strong> for “farewell” and <strong>K</strong> for “welfare.”</p>
  <button onclick="nextTrial()">Continue to Experiment</button>
</section>

<!-- TRIAL 4 — Welfare + Hand Gesture -->
<section id="trial4">
  <h2>Trial 4</h2>
  <div class="key-indicator">
    <div id="keyD4" class="key-box">D</div>
    <div id="keyK4" class="key-box">K</div>
  </div>
  <video id="vid4" autoplay playsinline preload="auto">
    <source src="https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception/main/video4.mp4" type="video/mp4">
  </video>
  <div class="loopProgressContainer">
    <div class="loopProgressBar" id="progress4"></div>
  </div>
  <p>Press <strong>D</strong> for “farewell” and <strong>K</strong> for “welfare.”</p>
  <button onclick="nextTrial()">Finish Experiment</button>
</section>

<!-- FINAL PAGE -->
<section id="thankYouMessage">
  <h2>Experiment Complete</h2>
  <p>You have finished the experiment.</p>
  <p>Please close this tab.</p>
</section>

<script>
// ---------- Subject + Version Assignment ----------
function getSubjectNumber() {
  let n = localStorage.getItem("subjectCounter");
  if (!n) {
    n = 1;
  } else {
    n = parseInt(n, 10) + 1;
  }
  localStorage.setItem("subjectCounter", n);
  return n;
}

function getExperimentVersion(subjectNumber) {
  // Odd -> Version1, Even -> Version2
  return subjectNumber % 2 === 0 ? "Version2" : "Version1";
}

// ---------- Global Config ----------
const TEST_MODE = false; // set to false to log data live
const API_URL = "https://sheetdb.io/api/v1/tar154b79cjl1";
const MAX_LOOPS = 100;
const trialLoopCounts = {};

const trialLabels = {
  trial1: "Audio only (A)",
  trial2: "Farewell + Hand",
  trial3: "Welfare + Hand",
  trial4: "AV Farewell"
};

// -------- Corrected Trial Orders --------

// Version 1 (odd subjects):
// 1. A only
// 2. Farewell + Hand
// 3. Welfare + Hand
// 4. AV Farewell
const trialOrder_Version1 = [
  { id: "trial1", next: "trial2", vid: "vid1", bar: "progress1" }, 
  { id: "trial2", next: "trial3", vid: "vid2", bar: "progress2" }, 
  { id: "trial3", next: "trial4", vid: "vid3", bar: "progress3" }, 
  { id: "trial4", next: "thankYouMessage", vid: "vid4", bar: "progress4" }
];

// Version 2 (even subjects):
// 1. A only
// 2. Welfare + Hand
// 3. Farewell + Hand
// 4. AV Farewell
const trialOrder_Version2 = [
  { id: "trial1", next: "trial3", vid: "vid1", bar: "progress1" }, 
  { id: "trial3", next: "trial2", vid: "vid3", bar: "progress3" }, 
  { id: "trial2", next: "trial4", vid: "vid2", bar: "progress2" }, 
  { id: "trial4", next: "thankYouMessage", vid: "vid4", bar: "progress4" }
];

let trialOrder = [];

// Mutation Observer to auto-start looping for the active trial
const observer = new MutationObserver(() => {
  const active = document.querySelector("section.active");
  if (!active) return;
  const trial = trialOrder.find(t => t.id === active.id);
  if (trial) {
    autoLoopVideo(trial.vid, trial.next, trial.bar);
  }
});

// ---------- ID Handling + Version Assignment ----------
function storeIDandContinue() {
  const idValue = document.getElementById("participantIdInput").value.trim();

  if (idValue === "") {
    document.getElementById("idError").style.display = "block";
    return;
  }

  // Store Penn ID
  localStorage.setItem("pennId", idValue);

  // Generate internal participant ID if needed
  if (!localStorage.getItem("participantId")) {
    localStorage.setItem("participantId", crypto.randomUUID());
  }

  // Subject number and version
  const subjectNumber = getSubjectNumber();
  localStorage.setItem("subjectNumber", subjectNumber);

  const experimentVersion = getExperimentVersion(subjectNumber);
  localStorage.setItem("experimentVersion", experimentVersion);
  // --- SWAP VIDEO SOURCES FOR TRIAL 2 AND TRIAL 3 BASED ON VERSION ---
  const vid2 = document.getElementById("vid2"); // Farewell + Hand
  const vid3 = document.getElementById("vid3"); // Welfare + Hand
  
  if (experimentVersion === "Version1") {
    // Version 1 (odd) → Farewell first, Welfare second
    vid2.src = "https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception-1/main/video2.mp4"; // Farewell
    vid3.src = "https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception-1/main/video3.mp4"; // Welfare
    } else {
    // Version 2 (even) → Welfare first, Farewell second
    vid2.src = "https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception-1/main/video3.mp4"; // Welfare
    vid3.src = "https://raw.githubusercontent.com/kamillehdz/speed-of-speech-perception-1/main/video2.mp4"; // Farewell
    }

// Force the browser to load the swapped videos immediately
vid2.load();
vid3.load();

  // Set trial order
  trialOrder = experimentVersion === "Version2"
    ? trialOrder_Version2
    : trialOrder_Version1;

  console.log("Assigned version:", experimentVersion);
  console.log("Trial order:", trialOrder.map(t => t.id).join(" → "));

  // Start observer now that trialOrder is known
  observer.observe(document.body, {
    subtree: true,
    attributes: true,
    attributeFilter: ["class"]
  });

  // Move to volume check
  showSection("volumeCheckScreen");
}

// ---------- Looping Videos ----------
function autoLoopVideo(videoId, nextSectionId, progressId) {
  const vid = document.getElementById(videoId);
  const bar = document.getElementById(progressId);
  if (!vid || !bar) return;

  if (!(videoId in trialLoopCounts)) {
    trialLoopCounts[videoId] = 0;
  }

  vid.onended = null;

  vid.play().catch(() => console.log("Autoplay requires user interaction"));

  vid.onended = () => {
    trialLoopCounts[videoId]++;

    bar.style.width =
      (trialLoopCounts[videoId] / MAX_LOOPS) * 100 + "%";

    if (trialLoopCounts[videoId] < MAX_LOOPS) {
      vid.currentTime = 0.0002; // tiny offset to reduce visible pause
      vid.play();
    } else {
      console.log(`${videoId} completed ${MAX_LOOPS} loops`);
      showSection(nextSectionId);
    }
  };
}

// ---------- Key Press Logging ----------
document.addEventListener("keydown", (e) => {
  const key = e.key.toLowerCase();
  if (!["d", "k"].includes(key)) return;

  const activeSection = document.querySelector("section.active");
  const activeVideo = activeSection ? activeSection.querySelector("video") : null;
  if (!activeVideo) return;

  const trialNum = activeSection.id.replace("trial", "");
  flashKey(`key${key.toUpperCase()}${trialNum}`);

  const sectionId = activeSection.id;
  const trialLabel = trialLabels[sectionId] || "Unknown condition";
  const videoTime = activeVideo.currentTime.toFixed(2).padEnd(5, "0");
  const currentLoop = trialLoopCounts[activeVideo.id] || 0;

  const now = new Date();
  const estTime = new Date(
    now.toLocaleString("en-US", { timeZone: "America/New_York" })
  );
  const formattedTime = estTime.toISOString();

  const entry = {
    participantId: localStorage.getItem("participantId") || "P" + Math.floor(Math.random() * 1e6),
    pennId: localStorage.getItem("pennId") || "UNKNOWN",
    subjectNumber: localStorage.getItem("subjectNumber") || "UNKNOWN",
    experimentVersion: localStorage.getItem("experimentVersion") || "UNKNOWN",
    sectionId: sectionId,
    trial: trialLabel,
    keyPressed: key,
    videoTime: videoTime,
    loopNumber: currentLoop + 1,
    timestampEST: formattedTime
  };

  console.log("Recorded:", entry);

  if (!TEST_MODE) {
    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: entry })
    }).catch(err => console.error("Logging error:", err));
  }
});

// ---------- Navigation Helpers ----------
function showSection(id) {
  document.querySelectorAll("video").forEach(v => {
    v.pause();
    v.currentTime = 0;
  });
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  const target = document.getElementById(id);
  if (target) {
    target.classList.add("active");
    window.scrollTo(0, 0);
  }
}

function nextTrial() {
  const active = document.querySelector("section.active");
  if (!active) return;
  const currentId = active.id;
  const t = trialOrder.find(t => t.id === currentId);
  if (t && t.next) {
    showSection(t.next);
  }
}

// Ensure participantId exists (backup)
if (!localStorage.getItem("participantId")) {
  localStorage.setItem("participantId", crypto.randomUUID());
}

// ---------- Visual Key Flash ----------
function flashKey(id) {
  const key = document.getElementById(id);
  if (!key) return;
  key.classList.add("active");
  setTimeout(() => key.classList.remove("active"), 200);
}
</script>
</body>
</html>
